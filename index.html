<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Ambilight Player</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: black;
      overflow: hidden;
      cursor: none;
    }

    #container {
      position: absolute;
      top: 5vh;
      left: 5vw;
      width: 90vw;
      height: 90vh;
      z-index: 1;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 30px rgba(255,255,255,0.1);
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: black;
    }

    .ambilight {
      position: fixed;
      z-index: 0;
      filter: blur(100px) brightness(2.2) saturate(1.4);
      pointer-events: none;
      animation: pulse 4s infinite ease-in-out;
    }

    @keyframes pulse {
      0%, 100% { filter: blur(100px) brightness(2.2) saturate(1.4); }
      50% { filter: blur(120px) brightness(2.8) saturate(1.6); }
    }

    #top, #bottom {
      width: 100vw;
      height: 5vh;
      left: 0;
    }

    #top { top: 0; }
    #bottom { bottom: 0; }

    #left, #right {
      width: 5vw;
      height: 100vh;
      top: 0;
    }

    #left { left: 0; }
    #right { right: 0; }

    #controls {
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 3;
      display: flex;
      gap: 10px;
      opacity: 1;
      transition: opacity 0.5s;
    }

    .btn {
      padding: 8px 14px;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }

    canvas {
      display: none;
    }

    #circle-ambilight {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 0;
      background: radial-gradient(circle at center, transparent 60%, rgba(255,255,255,0.1) 100%);
      mix-blend-mode: screen;
      transition: background 0.2s ease;
    }
  </style>
</head>
<body>

<div id="controls">
  <input type="file" id="fileInput" class="btn" accept="video/mp4,video/x-matroska,application/x-mpegURL">
  <button id="changeBtn" class="btn">Changer de vid√©o</button>
</div>

<div id="container">
  <video id="video" autoplay muted controls></video>
</div>

<!-- Ambilight zones -->
<div id="top" class="ambilight"></div>
<div id="bottom" class="ambilight"></div>
<div id="left" class="ambilight"></div>
<div id="right" class="ambilight"></div>
<div id="circle-ambilight"></div>

<canvas id="canvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  const fileInput = document.getElementById("fileInput");
  const changeBtn = document.getElementById("changeBtn");
  const controls = document.getElementById("controls");
  const circle = document.getElementById("circle-ambilight");

  const ambilightZones = {
    top: document.getElementById("top"),
    bottom: document.getElementById("bottom"),
    left: document.getElementById("left"),
    right: document.getElementById("right"),
  };

  let hls;

  function handleFile(file) {
    const url = URL.createObjectURL(file);
    const extension = file.name.split(".").pop().toLowerCase();

    if (hls) hls.destroy();

    if (extension === "m3u8" && Hls.isSupported()) {
      hls = new Hls();
      hls.loadSource(url);
      hls.attachMedia(video);
    } else {
      video.src = url;
    }

    video.play();
    document.documentElement.requestFullscreen();
    controls.style.opacity = "0";
    setTimeout(() => controls.style.display = "none", 500);
  }

  fileInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) handleFile(file);
  });

  changeBtn.addEventListener("click", () => {
    fileInput.click();
  });

  document.addEventListener("mousemove", () => {
    controls.style.display = "flex";
    controls.style.opacity = "1";
    clearTimeout(window.controlTimeout);
    window.controlTimeout = setTimeout(() => {
      controls.style.opacity = "0";
      setTimeout(() => controls.style.display = "none", 500);
    }, 2500);
  });

  function getAverageColor(data, width, height, x1, y1, x2, y2) {
    let r = 0, g = 0, b = 0, count = 0;
    for (let y = y1; y < y2; y++) {
      for (let x = x1; x < x2; x++) {
        const i = (y * width + x) * 4;
        r += data[i];
        g += data[i + 1];
        b += data[i + 2];
        count++;
      }
    }
    if (count === 0) return "black";
    return `rgb(${(r / count) | 0}, ${(g / count) | 0}, ${(b / count) | 0})`;
  }

  function updateAmbilight() {
    if (video.readyState >= 2 && video.videoWidth && video.videoHeight) {
      const vw = 96;
      const vh = 54;
      canvas.width = vw;
      canvas.height = vh;
      ctx.drawImage(video, 0, 0, vw, vh);
      const frame = ctx.getImageData(0, 0, vw, vh);
      const data = frame.data;

      ambilightZones.top.style.background = getAverageColor(data, vw, vh, 0, 0, vw, 6);
      ambilightZones.bottom.style.background = getAverageColor(data, vw, vh, 0, vh - 6, vw, vh);
      ambilightZones.left.style.background = getAverageColor(data, vw, vh, 0, 0, 4, vh);
      ambilightZones.right.style.background = getAverageColor(data, vw, vh, vw - 4, 0, vw, vh);
      circle.style.background = `radial-gradient(circle at center, transparent 60%, ${getAverageColor(data, vw, vh, 40, 20, 56, 34)} 100%)`;
    }

    requestAnimationFrame(updateAmbilight);
  }

  updateAmbilight();
</script>
</body>
</html>
