<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ambilight avec Liste m3u8</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: black;
      overflow: hidden;
      cursor: none;
    }
    #container {
      position: absolute;
      top: 5vh;
      left: 5vw;
      width: 90vw;
      height: 90vh;
      z-index: 1;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 30px rgba(255, 255, 255, 0.1);
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: black;
    }
    .ambilight {
      position: fixed;
      z-index: 0;
      filter: blur(90px) brightness(2.4) saturate(1.5);
      pointer-events: none;
      animation: pulse 5s infinite ease-in-out;
    }
    @keyframes pulse {
      0%, 100% { filter: blur(90px) brightness(2.4) saturate(1.5); }
      50% { filter: blur(110px) brightness(3) saturate(1.7); }
    }
    #top, #bottom {
      width: 100vw;
      height: 5vh;
      left: 0;
    }
    #top { top: 0; }
    #bottom { bottom: 0; }
    #left, #right {
      width: 5vw;
      height: 100vh;
      top: 0;
    }
    #left { left: 0; }
    #right { right: 0; }
    #controls {
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 3;
      display: flex;
      gap: 10px;
      opacity: 1;
      transition: opacity 0.5s;
      align-items: center;
    }
    .btn {
      padding: 8px 14px;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }
    select {
      padding: 8px 10px;
      border-radius: 6px;
      border: none;
      font-weight: bold;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.9);
    }
    canvas {
      display: none;
    }
    #circle-ambilight {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 0;
      background: radial-gradient(circle at center, transparent 65%, rgba(255,255,255,0.12) 100%);
      mix-blend-mode: screen;
      transition: background 0.2s ease;
    }
  </style>
</head>
<body>

<div id="controls">
  <input type="file" id="fileInput" class="btn" accept="video/mp4,video/x-matroska,application/x-mpegURL" style="display:none" />
  <button id="changeBtn" class="btn">Changer de vidéo</button>
  <select id="playlistSelect" title="Sélectionner une vidéo m3u8">
    <!-- Options ajoutées dynamiquement -->
  </select>
</div>

<div id="container">
  <video id="video" autoplay muted controls preload="auto"></video>
</div>

<!-- Zones Ambilight -->
<div id="top" class="ambilight"></div>
<div id="bottom" class="ambilight"></div>
<div id="left" class="ambilight"></div>
<div id="right" class="ambilight"></div>
<div id="circle-ambilight"></div>

<canvas id="canvas"></canvas>

<!-- Librairie HLS.js -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<script>
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  const fileInput = document.getElementById("fileInput");
  const changeBtn = document.getElementById("changeBtn");
  const controls = document.getElementById("controls");
  const circle = document.getElementById("circle-ambilight");
  const playlistSelect = document.getElementById("playlistSelect");

  const ambilightZones = {
    top: document.getElementById("top"),
    bottom: document.getElementById("bottom"),
    left: document.getElementById("left"),
    right: document.getElementById("right"),
  };

  const m3u8List = [
    "https://raw.githubusercontent.com/FreazDev/Ambilight/main/master.m3u8", // TEST public
    "https://dl34.topstrime.online/hls2/15/00307/,3leyyogsnhzz_x,lang/fre/3leyyogsnhzz_fre,.urlset/master.m3u8?t=wQIiuURsvTW_C7noyUX8cmP9OzeN-8bkCOvBDPULlg4&s=1749230850&e=43200&f=5066926&i=0.0&sp=0&fr=3leyyogsnhzz",
    "",
    ""
  ];

  function fillPlaylist() {
    playlistSelect.innerHTML = "";
    const defaultOpt = document.createElement("option");
    defaultOpt.text = "Sélectionner un film...";
    defaultOpt.value = "";
    playlistSelect.appendChild(defaultOpt);

    m3u8List.forEach(filename => {
      if (filename) {
        const opt = document.createElement("option");
        opt.value = filename;
        opt.text = filename.replace(".m3u8", "").replace(/_/g, " ");
        playlistSelect.appendChild(opt);
      }
    });
  }

  fillPlaylist();

  let hls;

  function loadVideoSource(src) {
    if (hls) {
      hls.destroy();
      hls = null;
    }

    video.pause();
    video.removeAttribute("src");

    if (src.endsWith(".m3u8") && Hls.isSupported()) {
      hls = new Hls();
      hls.loadSource(src);
      hls.attachMedia(video);
    } else {
      video.src = src;
    }

    video.play();
    if (document.fullscreenEnabled) {
      document.documentElement.requestFullscreen().catch(() => {});
    }

    controls.style.opacity = "0";
    setTimeout(() => controls.style.display = "none", 500);
  }

  fileInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) {
      const url = URL.createObjectURL(file);
      loadVideoSource(url);
      playlistSelect.value = "";
    }
  });

  changeBtn.addEventListener("click", () => {
    fileInput.click();
  });

  playlistSelect.addEventListener("change", () => {
    const val = playlistSelect.value;
    if (val) {
      loadVideoSource(val);
    }
  });

  document.addEventListener("mousemove", () => {
    controls.style.display = "flex";
    controls.style.opacity = "1";
    clearTimeout(window.controlTimeout);
    window.controlTimeout = setTimeout(() => {
      controls.style.opacity = "0";
      setTimeout(() => controls.style.display = "none", 500);
    }, 2500);
  });

  function getAverageColor(data, width, height, x1, y1, x2, y2) {
    let r = 0, g = 0, b = 0, count = 0;
    for (let y = y1; y < y2; y++) {
      for (let x = x1; x < x2; x++) {
        const i = (y * width + x) * 4;
        r += data[i];
        g += data[i + 1];
        b += data[i + 2];
        count++;
      }
    }
    if (count === 0) return "black";
    return `rgb(${(r / count) | 0}, ${(g / count) | 0}, ${(b / count) | 0})`;
  }

  function updateAmbilight() {
    if (video.readyState >= 2 && video.videoWidth && video.videoHeight) {
      const vw = 32;
      const vh = 18;
      canvas.width = vw;
      canvas.height = vh;
      ctx.drawImage(video, 0, 0, vw, vh);
      const frame = ctx.getImageData(0, 0, vw, vh);
      const data = frame.data;

      ambilightZones.top.style.background = getAverageColor(data, vw, vh, 0, 0, vw, 3);
      ambilightZones.bottom.style.background = getAverageColor(data, vw, vh, 0, vh - 3, vw, vh);
      ambilightZones.left.style.background = getAverageColor(data, vw, vh, 0, 0, 2, vh);
      ambilightZones.right.style.background = getAverageColor(data, vw, vh, vw - 2, 0, vw, vh);
      circle.style.background = `radial-gradient(circle at center, transparent 65%, ${getAverageColor(data, vw, vh, 13, 6, 19, 11)} 100%)`;
    }
  }

  // Fallback en cas de blocage du canvas
  function simulateAmbilight() {
    const simulatedColors = ["#ff5050", "#50ff50", "#5050ff", "#ffff50", "#50ffff"];
    let index = 0;

    setInterval(() => {
      const color = simulatedColors[index % simulatedColors.length];
      ambilightZones.top.style.background = color;
      ambilightZones.bottom.style.background = color;
      ambilightZones.left.style.background = color;
      ambilightZones.right.style.background = color;
      circle.style.background = `radial-gradient(circle at center, transparent 65%, ${color} 100%)`;
      index++;
    }, 3000);
  }

  function tryAmbilight() {
    try {
      canvas.width = 32;
      canvas.height = 18;
      ctx.drawImage(video, 0, 0, 32, 18);
      const data = ctx.getImageData(0, 0, 32, 18).data;
      if (data) {
        setInterval(updateAmbilight, 100);
      } else {
        throw "Canvas bloqué";
      }
    } catch (e) {
      console.warn("Ambilight dynamique désactivé : fallback simulation", e);
      simulateAmbilight();
    }
  }

  video.addEventListener("loadeddata", tryAmbilight);
</script>

</body>
</html>
